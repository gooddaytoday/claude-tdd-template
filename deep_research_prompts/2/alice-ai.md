Уже начала исследование. Ниже — план и ход его выполнения. Как только всё будет готово, я вернусь с готовым результатом.
# Оптимизация TDD-ориентированного Agent Harness для Claude Code CLI и Cursor IDE: Синтез лучших практик и рекомендации по совершенствованию

Настоящее исследование проведено с целью анализа и оптимизации TDD-ориентированного harness в репозитории `claude-tdd-template`, предназначенного для работы в средах Claude Code CLI и Cursor IDE. Основное внимание уделено 6-фазному TDD-циклу, оркестрируемому через TDD Integration Skill и интегрированному с Task Master AI. Исследование синтезирует актуальные практики 2025–2026 годов для повышения надёжности, точности и качества работы multi-agent системы.

## 1. Анализ текущей архитектуры TDD Harness

### 1.1. 6-фазный TDD-цикл с жёсткими gate-условиями
Система реализует строгий цикл, где каждая фаза имеет чёткий критерий перехода к следующей (gate-условие) [github.com](https://github.com/gooddaytoday/claude-tdd-template)[github.com](https://github.com/gooddaytoday/claude-tdd-template/blob/main/.claude/skills/tdd-integration/skill.md).
1.  **Pre-Phase:** Определение типа теста и получение контекста родительской задачи от Task Master.
2.  **Phase 1 (RED):** Агент `tdd-test-writer` пишет падающий тест. *Gate:* тест должен завершиться с ошибкой утверждения (assertion error), а не синтаксиса или импорта [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-test-writer.md).
3.  **Phase 2 (GREEN):** Агент `tdd-implementer` создаёт минимальную реализацию для прохождения теста. *Gate:* тест должен успешно пройти [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-implementer.md).
4.  **Phase 3 (REFACTOR):** Агент `tdd-refactorer` улучшает качество кода без изменения поведения. *Gate:* все тесты остаются зелёными [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-refactorer.md).
5.  **Phase 4 (CODE REVIEW):** Агент `tdd-code-reviewer` проводит проверку качества кода. *Gate:* отсутствие critical/major проблем. Обнаруженные проблемы возвращаются в виде структурированного `FixRequest[]` для маршрутизации основным оркестратором [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-code-reviewer.md).
6.  **Phase 5 (ARCHITECTURE REVIEW):** Агент `tdd-architect-reviewer` проверяет интеграцию кода в проект. *Gate:* код интегрирован; на последнем подзадании выполняется Full Task Review [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-architect-reviewer.md).
7.  **Phase 6 (DOCUMENTATION):** Агент `tdd-documenter` сохраняет результаты в task-master и обновляет документацию. *Gate:* документация сохранена [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-documenter.md).

### 1.2. Распределение ролей и моделей между агентами
Каждому агенту назначена оптимальная модель LLM для его задачи, что балансирует качество и стоимость выполнения [github.com](https://github.com/gooddaytoday/claude-tdd-template)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-implementer.md)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-refactorer.md)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-test-writer.md):
*   **tdd-architect-reviewer:** Claude 3.5 Opus (для сложного архитектурного анализа).
*   **tdd-test-writer, tdd-implementer, tdd-code-reviewer, tdd-refactorer:** Claude 3.5 Sonnet.
*   **tdd-documenter:** Claude 3.5 Haiku (для эффективного документирования).

### 1.3. Техническое обеспечение TDD: Guard Hooks и Fix-Routing
**Механизм защиты тестов (TDD Guard):** Хук `prevent-test-edit.ts` обеспечивает жёсткое исполнение принципа read-only для тестов во всех фазах, кроме RED. Он отслеживает активного субагента через временный файл состояния и блокирует любые попытки редактирования файлов в `tests/**` для агентов `implementer`, `refactorer`, `code-reviewer`, `architect-reviewer` и `documenter` [github.com](https://github.com/gooddaytoday/claude-tdd-template)[github.com](https://github.com/gooddaytoday/claude-tdd-template/blob/main/.claude/hooks/prevent-test-edit.ts)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/hooks/prevent-test-edit.ts). Хук также защищает конфигурационные файлы Jest (`jest.*.config.[jt]s`), возвращая запрос разрешения (`ask`) при попытке их изменения вне фазы RED или главным агентом.

**Паттерн FixRequest и централизованная маршрутизация:** Ключевое архитектурное решение — ревьюеры не вносят исправления самостоятельно, а возвращают структурированный массив `FixRequest[]`. Основной оркестратор в `skill.md` анализирует эти запросы, группирует их по полю `routeTo` (`implementer` для исправлений логики и типов, `refactorer` для улучшения структуры кода) и делегирует выполнение соответствующему субагенту [github.com](https://github.com/gooddaytoday/claude-tdd-template/blob/main/.claude/skills/tdd-integration/skill.md)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/skills/tdd-integration/skill.md). Для архитектурных исправлений `routeTo` всегда указывает на `implementer`. Система предусматривает до 3 циклов исправления-проверки, после чего проблема эскалируется пользователю.

### 1.4. Контракты взаимодействия: Phase Packets и Self-Verification
**Phase Packets:** Каждый агент возвращает стандартизированный вывод (Phase Packet), который содержит все необходимые данные для принятия решения о переходе к следующей фазе. Пакеты включают поля: `Phase`, `Status`, `Test file`, `Test command`, `Changed files`, а также специфичные для фазы данные (например, `FixRequest[]` для ревью, `IntegrationVerdict` для архитектурного анализа) [github.com](https://github.com/gooddaytoday/claude-tdd-template)[github.com](https://github.com/gooddaytoday/claude-tdd-template/blob/main/.claude/skills/tdd-integration/skill.md).

**Self-Verification Checklists:** Перед возвратом результата каждый агент обязан выполнить внутреннюю проверку. Например, `tdd-test-writer` проверяет, что тест падает именно с assertion error; `tdd-implementer` — что тест проходит и файлы тестов не изменены; `tdd-code-reviewer` — что все FixRequest-поля заполнены [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-code-reviewer.md)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-implementer.md)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-test-writer.md). Эти чек-листы служат первой линией защиты от ошибок.

### 1.5. Интеграции и автоматизация
*   **Автоактивация TDD Skill:** Хук `user-prompt-skill-eval.ts` анализирует входящий запрос пользователя и автоматически активирует `Skill(tdd-integration)` для запросов на реализацию, добавление фич или создание, минуя TDD для исправлений багов, документации или конфигурации [github.com](https://github.com/gooddaytoday/claude-tdd-template).
*   **Глубокая интеграция с Task Master AI:** Контекст родительской задачи передаётся через все фазы цикла. На последнем подзадании `tdd-architect-reviewer` выполняет Full Task Review, проверяя интеграцию всех компонентов, созданных в рамках задачи, и при необходимости создаёт дополнительные подзадания для устранения "осиротевшего" кода [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-architect-reviewer.md).
*   **Система разрешений:** Файл `settings.json` определяет гранулярные правила `allow`/`deny`/`ask` для инструментов и путей файлов, обеспечивая безопасность и контроль. Для каждого TDD-агента заданы отдельные разрешения через `Task(tdd-*:*)` [github.com](https://github.com/gooddaytoday/claude-tdd-template/blob/main/.claude/settings.json)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/settings.json).

## 2. Лучшие практики TDD для AI-агентов (2025–2026)

Исследование авторитетных источников и актуальных публикаций выявило несколько ключевых направлений для оптимизации agentic workflow.

**2.1. Specification-as-Code и расширенные feedback loops.** Традиционный цикл red-green-refactor рассматривается как формальная state machine. Тесты выступают в роли исполняемой спецификации (specification-as-code), а fitness functions и контракты (Design by Contract) кодируют архитектурные и поведенческие ограничения, что обеспечивает AI-агенту однозначное понимание требований [www.linkedin.com](https://www.linkedin.com/pulse/test-driven-agentic-development-how-tdd-can-enable-coding-monnette-2k80f). Эффективные harnesses для long-running агентов подчёркивают важность артефактов, позволяющих следующему экземпляру агента понять состояние работы и продолжить с правильного места, предотвращая "угадывание" или преждевременное объявление завершения [www.anthropic.com](https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents).

**2.2. Многоуровневая верификация и предотвращение галлюцинаций.** Самостоятельная проверка агентом своего вывода (self-verification) признана необходимой, но недостаточной [gist.github.com](https://gist.github.com/skew202/043f00e04da3307d69e20efe4d2bbb6a). Рекомендуется внедрение многослойной системы валидации, которая включает автоматические проверки в CI/CD, оценку с помощью LLM-as-a-judge (например, с использованием фреймворков типа DeepEval), кросс-ревью между агентами и финальный human-in-the-loop [dev.to](https://dev.to/kamya_shah_e69d5dd78f831c/5-ways-to-detect-ai-agent-hallucinations-3hb8)[habr.com](https://habr.com/ru/articles/955314/)[www.ada.cx](https://www.ada.cx/blog/preventing-hallucinations-in-ai-best-practices-for-customer-service-ai-agents/). Для Phase Packets и подобных структур критически важна проверка семантической согласованности и фактического соответствия заявленного статуса (например, `passed`) реальному состоянию системы (например, результаты прогона тестов) [medium.com](https://medium.com/@dimitri_fioole/how-to-test-agentforce-guardrails-and-prevent-hallucinations-d4691ea60cdd).

**2.3. Управление сложностью multi-agent workflow и anti-patterns.** В распределённых агентских системах распространены anti-patternы: нечёткие роли агентов, неограниченная автономия и петли самоделегирования, каскадное распространение галлюцинаций, "расползание" контекста (context sprawl) и неадекватный выбор инструментов оркестрации [medium.com](https://medium.com/@armankamran/anti-patterns-in-multi-agent-gen-ai-solutions-enterprise-pitfalls-and-best-practices-ea39118f3b70). Успешные реализации делают акцент на чётком разделении ответственности, контроле потока выполнения, тщательном логировании всех действий и трассируемости решений для эффективной отладки [habr.com](https://habr.com/ru/companies/domclick/articles/966066/).

**2.4. Адаптивные стратегии и метрики качества.** Жёсткие лимиты (например, 3 цикла fix-routing) могут быть неоптимальны. Исследования в области адаптивной маршрутизации в multi-agent системах предлагают использовать reinforcement learning для динамической настройки параметров маршрутизации на основе наблюдаемой производительности сети агентов [arxiv.org](https://arxiv.org/abs/2503.07686). Для непрерывного улучшения harness необходимы метрики, выходящие за рамки простого прохождения/непрохождения тестов. Это могут быть метрики точности маршрутизации FixRequest, время прохождения каждой фазы, коэффициент обнаружения дефектов на каждом этапе, а также метрики, отслеживающие каскадные сбои [sre.google](https://sre.google/sre-book/addressing-cascading-failures/)[techcommunity.microsoft.com](https://techcommunity.microsoft.com/blog/azure-ai-foundry-blog/evaluating-agentic-ai-systems-a-deep-dive-into-agentic-metrics/4403923)[www.deepchecks.com](https://www.deepchecks.com/agentic-workflow-evaluation-key-metrics-methods/).

## 3. Выявленные gaps и области для улучшения

Сравнение текущей реализации с синтезированными лучшими практиками позволяет выделить следующие потенциальные узкие места и возможности для оптимизации.

**3.1. Ограниченная устойчивость механизма TDD Guard.** Хотя хук `prevent-test-edit.ts` реализует базовую защиту, его внутренняя реализация и стратегия управления состоянием (файл `.claude/.guard-state.json`) требуют более детального анализа на предмет устойчивости к новым векторам обхода. Существуют сторонние решения, такие как `tdd-guard`, которые предлагают более глубокую интеграцию с test runners (Jest, Vitest) для валидации TDD-цикла на уровне выполнения тестов [github.com](https://github.com/nizos/tdd-guard).

**3.2. Риск неточной маршрутизации FixRequest и "галлюцинаций" в Phase Packets.** Правила назначения `routeTo: implementer | refactorer` декларативны и полагаются на корректную классификацию проблемы агентом-ревьюером. Ошибка в классификации может привести к неэффективному циклу исправлений. Кроме того, существует риск, когда агент возвращает Phase Packet со статусом `passed`, но фактическое выполнение тестовой команды (`verificationCommand`) не проводилось или завершилось с ошибкой — разновидность галлюцинации о состоянии системы [dev.to](https://dev.to/kamya_shah_e69d5dd78f831c/5-ways-to-detect-ai-agent-hallucinations-3hb8).

**3.3. Жёсткие лимиты и потенциальные каскадные сбои.** Фиксированный лимит в 3 цикла fix-routing не учитывает сложность или тип проблемы. Некоторые критические архитектурные исправления могут требовать больше итераций, в то время как тривиальные стилевые правки — меньше. Также система уязвима к каскадным сбоям: если gate-условие фазы (например, тест должен упасть в RED) будет ложно удовлетворено (false positive), ошибка распространится на все последующие фазы [sre.google](https://sre.google/sre-book/addressing-cascading-failures/).

**3.4. Отсутствие системного сбора метрик для continuous improvement.** В harness не заложена инфраструктура для сбора количественных данных о работе TDD-цикла: точности маршрутизации FixRequest, средней длительности фаз, частоте срабатывания guard hook, эффективности Self-Verification Checklists. Без этих данных затруднено обоснованное принятие решений по оптимизации архитектуры [techcommunity.microsoft.com](https://techcommunity.microsoft.com/blog/azure-ai-foundry-blog/evaluating-agentic-ai-systems-a-deep-dive-into-agentic-metrics/4403923)[www.deepchecks.com](https://www.deepchecks.com/agentic-workflow-evaluation-key-metrics-methods/).

**3.5. Контекстная перегруженность и потенциальные anti-patternы.** Хотя использование субагентов изолирует контекст, существует риск anti-patternа "overlapping roles" или неоптимальной оркестрации при росте сложности workflow, особенно при интеграции с внешними MCP-серверами и Task Master AI [github.com](https://github.com/roguetrainer/multi-agent-team/blob/main/docs/PATTERNS.md)[medium.com](https://medium.com/@armankamran/anti-patterns-in-multi-agent-gen-ai-solutions-enterprise-pitfalls-and-best-practices-ea39118f3b70).

## 4. Рекомендации по оптимизации TDD Harness

На основе проведённого анализа предлагаются следующие рекомендации, приоритизированные по ожидаемому влиянию на надёжность и качество цикла.

**4.1. Усиление механизмов проверки и предотвращения галлюцинаций.**
*   **Внешняя валидация Phase Packets:** Дополнить логику основного оркестратора обязательным автоматическим выполнением `verificationCommand` из Phase Packet (если указана) перед принятием статуса фазы. Результат выполнения должен сверяться с заявленным статусом (`passed`/`failed`).
*   **Внедрение Critic-агента для FixRequest:** Добавить легковесного агента (на модели Haiku), который проверяет корректность и непротиворечивость массива `FixRequest[]`, возвращаемого ревьюерами, перед началом маршрутизации. Это позволит отсечь очевидные ошибки классификации.
*   **Расширение Self-Verification:** Добавить в чек-лист `tdd-code-reviewer` и `tdd-architect-reviewer` пункт о предоставлении короткого excerpt реального вывода тестовой команды, подтверждающего текущее "зелёное" состояние системы [raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/agents/tdd-code-reviewer.md)[raw.githubusercontent.com](https://raw.githubusercontent.com/gooddaytoday/claude-tdd-template/main/.claude/skills/tdd-integration/skill.md).

**4.2. Совершенствование маршрутизации FixRequest и лимитов.**
*   **Уточнение алгоритма `routeTo`:** Детализировать критерии в документации агентов-ревьюеров. Например, `routeTo: implementer` для любых изменений, затрагивающих публичные API, типы или бизнес-логику; `routeTo: refactorer` — только для реструктуризации приватных функций, переименований, устранения дублирования внутри уже работающей реализации.
*   **Адаптивный лимит циклов:** Заменить фиксированный лимит в 3 цикла на адаптивную стратегию. Например, начать с лимита в 2 цикла для `severity: minor`, 3 для `major` и 4 для `critical`. В перспективе можно накапливать историю успешных исправлений для прогнозирования необходимого числа итераций [arxiv.org](https://arxiv.org/abs/2503.07686).
*   **Приоритизация и батчинг:** Реализовать в оркестраторе логику сортировки `FixRequest[]` по `severity` и группировку исправлений в одном файле перед отправкой агенту для минимизации количества вызовов.

**4.3. Внедрение системы мониторинга и метрик.**
*   **Сбор базовых метрик:** Модифицировать `skill.md` для логирования в структурированном формате (JSONL) ключевых событий: старт/финиш фазы, результат выполнения `verificationCommand`, список и статус FixRequest. Это можно делать в отдельный файл (например, `.claude/.tdd-cycle-log.jsonl`).
*   **Определение ключевых показателей:** На основе собранных данных рассчитать метрики:
    *   **Точность маршрутизации (Routing Accuracy):** Процент FixRequest, после исправления которых не потребовалось перенаправление другому агенту или повторный ревью.
    *   **Эффективность Self-Verification (Self-Verification Efficacy):** Процент фатальных проблем, которые были пропущены Self-Verification Checklist агента, но пойманы на следующей фазе.
    *   **Время цикла (Cycle Time):** Распределение времени выполнения по фазам.
    *   **Коэффициент каскадных сбоев (Cascade Failure Rate):** Частота ситуаций, когда ошибка в одной фазе приводила к откату или сбою в последующих [sre.google](https://sre.google/sre-book/addressing-cascading-failures/)[www.deepchecks.com](https://www.deepchecks.com/agentic-workflow-evaluation-key-metrics-methods/).
*   **Визуализация и алертинг:** Настроить простой дашборд (например, на основе скрипта, генерирующего markdown-отчёт) для просмотра метрик. Критические отклонения (например, рост Cascade Failure Rate) могут триггерить уведомление.

**4.4. Укрепление TDD Guard и интеграция.**
*   **Аудит реализации хука:** Провести ревизию кода `prevent-test-edit.ts` на предмет полноты обработки edge-case (например, попытка редактирования теста через симлинк, косвенное изменение через редактирование файла, который генерирует тесты).
*   **Интеграция с инструментами тестирования:** Рассмотреть возможность использования или заимствования подходов из проекта `tdd-guard` [github.com](https://github.com/nizos/tdd-guard), где валидация TDD (например, "тест действительно падал перед реализацией") происходит на уровне репортёра для test runner (Jest/Vitest), что обеспечивает более глубокий контроль.
*   **Защита конфигурации:** Расширить защиту хука не только на `jest.*.config.[jt]s`, но и на другие ключевые конфигурационные файлы тестовой среды (например, `setupFiles`, `globalSetup`).

**4.5. Документирование паттернов и anti-patternов для разработчиков.**
*   **Создание внутреннего playbook:** Включить в `CLAUDE.md` или отдельный документ описание типичных сбоев в multi-agent TDD workflow и способы их диагностики. Например, "агент implementer не может пройти тест — проверьте, не изменился ли неявно контракт API, который требует обновления теста (но это должен сделать test-writer)" [medium.com](https://medium.com/@armankamran/anti-patterns-in-multi-agent-gen-ai-solutions-enterprise-pitfalls-and-best-practices-ea39118f3b70).
*   **Шаблоны для сложных сценариев:** Разработать и задокументировать в `skill.md` расширенные сценарии оркестрации для случаев, когда одна фича требует создания нескольких взаимосвязанных модулей, разнесённых по разным подзаданиям.

Внедрение данных рекомендаций позволит трансформировать текущий эффективный TDD harness в более устойчивую, самообучающуюся и наблюдаемую систему, соответствующую передовым практикам разработки AI-агентов в 2026 году. Ключевыми направлениями являются усиление верификации артефактов, внедрение адаптивного управления workflow и создание цикла непрерывного улучшения на основе данных.